import { convertExpressRequestToStandardRequest } from "./request.js";
export const handleMiddleware = (auth) => {
    const middleware = async (req, res, next) => {
        req.app.locals.setSession = (session) => {
            const cookies = auth.createSessionCookies(session);
            res.append("Set-Cookie", cookies.map((val) => val.serialize()).toString());
        };
        req.app.locals.getSession = async () => {
            try {
                return await auth.validateRequest(convertExpressRequestToStandardRequest(req, auth), req.app.locals.setSession);
            }
            catch {
                return null;
            }
        };
        req.app.locals.getSessionUser = async () => {
            try {
                return await auth.getSessionUserFromRequest(convertExpressRequestToStandardRequest(req, auth), req.app.locals.setSession);
            }
            catch {
                return {
                    session: null,
                    user: null
                };
            }
        };
        next();
    };
    return middleware;
};
